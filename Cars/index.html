<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dune Buggy Duel</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<style>
    body { margin: 0; overflow: hidden; background: #111; }
    #ui {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        font-family: Arial;
        font-size: 20px;
        text-align: center;
        z-index: 10;
    }
    button {
        padding: 8px 16px;
        font-size: 16px;
        margin-top: 8px;
    }
</style>
</head>
<body>

<div id="ui">
    <div id="status">Dune Buggy Duel</div>
    <button onclick="restart()">Restart</button>
</div>

<script>
const {
    Engine, Render, Runner, Bodies,
    Composite, Constraint, Events, Body
} = Matter;

let engine, world, render, runner;
let player1, player2;
let keys = {};
let gameOver = false;

init();

function init() {

    engine = Engine.create();
    world = engine.world;
    world.gravity.y = 1;

    render = Render.create({
        element: document.body,
        engine: engine,
        options: {
            width: window.innerWidth,
            height: window.innerHeight,
            wireframes: false,
            background: '#222'
        }
    });

    Render.run(render);
    runner = Runner.create();
    Runner.run(runner, engine);

    createTerrain();
    player1 = createCar(300, 300, "#00ccff", "P1");
    player2 = createCar(900, 300, "#ff4444", "P2");

    setupCollision();
}

function createTerrain() {
    const ground = Bodies.rectangle(2000, window.innerHeight - 50, 4000, 100, {
        isStatic: true,
        render: { fillStyle: "#444" }
    });

    Composite.add(world, ground);

    for (let i = 0; i < 10; i++) {
        let hill = Bodies.rectangle(
            i * 400 + 400,
            window.innerHeight - 200 - Math.random() * 200,
            400,
            30,
            {
                isStatic: true,
                angle: (Math.random() - 0.5) * 0.5,
                render: { fillStyle: "#555" }
            }
        );
        Composite.add(world, hill);
    }
}

function createCar(x, y, color, label) {

    const chassis = Bodies.rectangle(x, y, 100, 30, {
        density: 0.002,
        friction: 0.8,
        render: { fillStyle: color }
    });

    const wheelA = Bodies.circle(x - 35, y + 25, 20, {
        friction: 1,
        render: { fillStyle: "#888" }
    });

    const wheelB = Bodies.circle(x + 35, y + 25, 20, {
        friction: 1,
        render: { fillStyle: "#888" }
    });

    const head = Bodies.circle(x, y - 30, 15, {
        label: label + "_HEAD",
        render: { fillStyle: "#fff" }
    });

    const axelA = Constraint.create({
        bodyA: chassis,
        pointA: { x: -35, y: 20 },
        bodyB: wheelA,
        stiffness: 0.9
    });

    const axelB = Constraint.create({
        bodyA: chassis,
        pointA: { x: 35, y: 20 },
        bodyB: wheelB,
        stiffness: 0.9
    });

    const neck = Constraint.create({
        bodyA: chassis,
        pointA: { x: 0, y: -15 },
        bodyB: head,
        stiffness: 0.9
    });

    Composite.add(world, [chassis, wheelA, wheelB, head, axelA, axelB, neck]);

    return { chassis, wheelA, wheelB, head, label };
}

document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

Events.on(engine, "beforeUpdate", () => {
    if (gameOver) return;

    handleControls(player1, keys["a"], keys["d"]);
    handleControls(player2, keys["ArrowLeft"], keys["ArrowRight"]);
});

function handleControls(car, backward, forward) {
    const torque = 0.05;

    if (forward) {
        Body.setAngularVelocity(car.wheelA, torque);
        Body.setAngularVelocity(car.wheelB, torque);
    }
    if (backward) {
        Body.setAngularVelocity(car.wheelA, -torque);
        Body.setAngularVelocity(car.wheelB, -torque);
    }
}

function setupCollision() {
    Events.on(engine, "collisionStart", event => {
        if (gameOver) return;

        event.pairs.forEach(pair => {
            checkCrash(pair.bodyA, pair.bodyB);
            checkCrash(pair.bodyB, pair.bodyA);
        });
    });
}

function checkCrash(bodyA, bodyB) {
    if (!bodyA.label.includes("_HEAD")) return;

    const owner = bodyA.label.split("_")[0];
    const car = owner === "P1" ? player1 : player2;

    if (bodyB !== car.chassis &&
        bodyB !== car.wheelA &&
        bodyB !== car.wheelB) {

        endGame(owner === "P1" ? "Player 2 Wins!" : "Player 1 Wins!");
    }
}

function endGame(message) {
    gameOver = true;
    document.getElementById("status").innerText = message;
    Runner.stop(runner);
}

function restart() {
    location.reload();
}
</script>

</body>
</html>